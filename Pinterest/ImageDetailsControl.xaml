<UserControl x:Class="Pinterest.ImageDetailsControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:Pinterest"
             Height="Auto" Width="Auto">

    <UserControl.Resources>
        <local:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <local:InverseBoolConverter x:Key="InverseBoolConverter"/>
        <local:BoolToShowHideConverter x:Key="BoolToShowHideConverter"/>

        <!-- Стиль для заголовков -->
        <Style x:Key="HeaderTextBlockStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Margin" Value="0,10,0,5"/>
            <Setter Property="Foreground" Value="#333"/>
        </Style>

        <!-- Стиль для кнопок -->
        <Style x:Key="PrimaryButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#0078D7"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="Margin" Value="5,0,0,0"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
            <Setter Property="MinWidth" Value="80"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                CornerRadius="3" 
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#005A9E"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#003E6B"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Background" Value="#AAA"/>
                                <Setter Property="Foreground" Value="#666"/>
                                <Setter Property="Cursor" Value="Arrow"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Стиль для Image с эффектом наведения -->
        <Style x:Key="HoverImageStyle" TargetType="Image">
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="UseLayoutRounding" Value="True"/>
            <Setter Property="Cursor" Value="Arrow"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="0" BlurRadius="0" Opacity="0"/>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Cursor" Value="Hand"/>
                    <Setter Property="Effect">
                        <Setter.Value>
                            <DropShadowEffect Color="#444" ShadowDepth="0" BlurRadius="8" Opacity="0.6"/>
                        </Setter.Value>
                    </Setter>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Стиль для TextBox -->
        <Style x:Key="StandardTextBoxStyle" TargetType="TextBox">
            <Setter Property="BorderBrush" Value="#CCC"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="Margin" Value="0,0,0,10"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Foreground" Value="#222"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>

        <!-- Стиль для Hyperlink -->
        <Style TargetType="Hyperlink">
            <Setter Property="Foreground" Value="#0078D7"/>
            <Setter Property="TextDecorations" Value="Underline"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Foreground" Value="#005A9E"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Стиль для ItemsControl контейнера похожих изображений -->
        <Style x:Key="SimilarImagesItemsControlStyle" TargetType="ItemsControl">
            <Setter Property="Margin" Value="0,5,0,0"/>
        </Style>

    </UserControl.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <Grid Margin="10" MaxWidth="1000">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*" />
                    <ColumnDefinition Width="3*" />
                </Grid.ColumnDefinitions>

                <!-- Изображение -->
            <StackPanel Grid.Column="0" HorizontalAlignment="Center" VerticalAlignment="Top">
                <Button Content="Назад" Command="{Binding BackCommand}" Style="{StaticResource PrimaryButtonStyle}" Width="80" Margin="0,0,0,10"/>
                <Image MaxWidth="450"
       Stretch="Uniform"
       HorizontalAlignment="Center"
       Source="{Binding ImageSource}" 
       Style="{StaticResource HoverImageStyle}" 
       Margin="0,0,0,10"/>

                <TextBlock Text="{Binding LikesCount}" FontSize="14" Margin="0,5,0,5" Foreground="#666" TextAlignment="Center"/>
                <Button Content="{Binding LikeButtonText}" Command="{Binding LikeCommand}" 
                        CommandParameter="{Binding Meta}" 
                        Style="{StaticResource PrimaryButtonStyle}" Width="150" HorizontalAlignment="Center"/>
            </StackPanel>

            <!-- Детали -->
            <StackPanel Grid.Column="1" Margin="20,0,0,0">
                <TextBlock Text="{Binding Title}" Style="{StaticResource HeaderTextBlockStyle}"/>

                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                    <TextBlock Text="Автор: " FontWeight="Bold" VerticalAlignment="Center" Foreground="#333"/>
                    <TextBlock Margin="5,0,0,0" VerticalAlignment="Center">
                        <Hyperlink Command="{Binding OpenAuthorProfileCommand}" CommandParameter="{Binding Author}">
                            <Run Text="{Binding Author}" />
                        </Hyperlink>
                    </TextBlock>
                </StackPanel>

                <TextBlock Text="{Binding Description}" FontSize="14" Margin="0,0,0,10" TextWrapping="Wrap" Foreground="#333"/>
                <TextBlock Text="{Binding Tags}" Margin="0,0,0,10" Foreground="#555" FontSize="14"/>

                <Button Width="150" Margin="0,0,0,10" Command="{Binding SubscribeCommand}" CommandParameter="{Binding Meta}" 
                        Visibility="{Binding CanSubscribe, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource PrimaryButtonStyle}">
                            <Setter Property="Content" Value="🔔 Подписаться"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsSubscribed}" Value="True">
                                    <Setter Property="Content" Value="🚫 Отписаться"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <StackPanel Orientation="Horizontal" Margin="0,10,0,0" VerticalAlignment="Center">
                    <TextBlock Text="Добавить в коллекцию:" Margin="0,0,10,0" VerticalAlignment="Center"/>
                    <ComboBox Width="200" ItemsSource="{Binding UserCollections}"
                              SelectedItem="{Binding SelectedCollection, Mode=TwoWay}"
                              IsSynchronizedWithCurrentItem="True"/>
                    <Button Content="{Binding AddToCollectionButtonText}" Command="{Binding AddToCollectionCommand}" 
                            Style="{StaticResource PrimaryButtonStyle}" Width="80" Margin="10,0,0,0"/>
                </StackPanel>
                <TextBlock Text="{Binding AddToCollectionMessage}" Foreground="Green" FontSize="12" Margin="0,5,0,0"/>

                <!-- Комментарии -->
                <TextBlock Text="Комментарии" FontSize="14" FontWeight="Bold" Margin="0,20,0,5"/>
                <ItemsControl ItemsSource="{Binding VisibleComments}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Margin="5,0,0,5">
                                <TextBlock Text="{Binding UserName}" FontWeight="Bold" Margin="0,0,10,0"/>
                                <TextBlock Text="{Binding Text}" TextWrapping="Wrap" Width="250"/>
                                <Button Content="{Binding IsHidden, Converter={StaticResource BoolToShowHideConverter}}"
                                        Margin="10,0,0,0"
                                        Visibility="{Binding DataContext.IsAdmin, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVisibilityConverter}}"
                                        Command="{Binding DataContext.ToggleCommentVisibilityCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}"
                                        Style="{StaticResource PrimaryButtonStyle}" Width="60"/>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <StackPanel Orientation="Horizontal" Margin="0,5,0,10">
                    <TextBox Width="300" Height="60" AcceptsReturn="True" TextWrapping="Wrap"
                             Text="{Binding FeedbackMessage, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource StandardTextBoxStyle}" Margin="0,0,10,0"/>
                    <Button Content="💬 Отправить" Command="{Binding AddCommentCommand}" 
                            Style="{StaticResource PrimaryButtonStyle}" Width="100"/>
                </StackPanel>

                <!-- Удаление -->
                <Button Content="🗑️ Удалить изображение" 
                        Visibility="{Binding CanDeleteImage, Converter={StaticResource BoolToVisibilityConverter}}"
                        Command="{Binding DeleteImageCommand}" 
                        Style="{StaticResource PrimaryButtonStyle}" Width="200" Margin="0,10,0,0"/>

                <!-- Админка -->
                <StackPanel Visibility="{Binding IsAdmin, Converter={StaticResource BoolToVisibilityConverter}}" Margin="0,20,0,0">
                    <TextBlock Text="🔧 Администрирование" Style="{StaticResource HeaderTextBlockStyle}"/>
                        <!-- Кнопка для блокировки пользователя -->
                        <Button Width="300" Margin="0,5,0,5"
            Command="{Binding ToggleBanUserCommand}"
            CommandParameter="{Binding Meta.UploadedBy}"
            Style="{StaticResource PrimaryButtonStyle}"
            Content="{Binding BanButtonText}"/>

                        <!-- Новая кнопка для разрешения/запрета загрузки изображений -->
                        <Button Width="300" Margin="0,5,0,5"
            Command="{Binding ToggleUploadPermissionCommand}"
            CommandParameter="{Binding Meta.UploadedBy}"
            Style="{StaticResource PrimaryButtonStyle}"
            Content="{Binding UploadPermissionButtonText}"/>
                        <TextBlock Text="Редактировать изображение" FontWeight="Bold" Margin="0,10,0,5"/>
                    <TextBox Text="{Binding EditableTitle}" Width="300" Style="{StaticResource StandardTextBoxStyle}" />
                    <TextBox Text="{Binding EditableTags}" Width="300" Style="{StaticResource StandardTextBoxStyle}" />
                    <TextBox Text="{Binding EditableDescription}" Width="300" Height="60" AcceptsReturn="True"
                             TextWrapping="Wrap" Style="{StaticResource StandardTextBoxStyle}" />
                    <Button Content="💾 Сохранить изменения" Command="{Binding EditImageCommand}" 
                            Style="{StaticResource PrimaryButtonStyle}" Width="200" Margin="0,5,0,5"/>
                    <TextBlock Text="{Binding ViewCount, StringFormat='Просмотры: {0}'}" FontWeight="Bold" Margin="0,10,0,0"/>
                </StackPanel>
            </StackPanel>
            </Grid>

            <!-- Похожие изображения -->
            <StackPanel Grid.Row="1" Grid.ColumnSpan="2" Margin="0,20,0,0">
                <TextBlock Text="Похожие изображения" Style="{StaticResource HeaderTextBlockStyle}" Margin="5"/>
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding SimilarImages}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <local:MasonryPanel ItemWidth="110"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="5" Width="110" HorizontalAlignment="Center">
                                    <Image Width="140" Stretch="Uniform"
                               Source="{Binding ImageSource}" Style="{StaticResource HoverImageStyle}">
                                        <Image.InputBindings>
                                            <MouseBinding Gesture="LeftClick"
                                              Command="{Binding DataContext.OpenSimilarImageCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                              CommandParameter="{Binding}" />
                                        </Image.InputBindings>
                                    </Image>
                                    <TextBlock Text="{Binding OriginalName}" FontSize="12" TextAlignment="Center"
                                   Width="100" TextWrapping="Wrap" Margin="0,5,0,0"/>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </StackPanel>

        </Grid>
    </ScrollViewer>
</UserControl>